<form method="post" action="/_api" class="form-horizontal" target="ifr_form" autocomplete="off">
<input type="hidden" name="do" value="base">
<fieldset>
<legend>api基础信息

<span class="legend_note pull-right">
{{if .api.Exists}}
<a href="/_analysis?name={{.api.Name}}">Http Analysis</a>&nbsp;
{{end}}
pv: &nbsp;<span id="api_pv_{{.api.Name}}">{{.api.GetPv}}</span>&nbsp;
</span>
</legend>

<div class="form-group">
    <label class="col-sm-2 control-label">模块名称:</label>
    <div class="col-sm-3">
        {{if .api.Exists}}
        <input type="hidden" name="api_name" value="{{.api.Name|html}}">
        <input type="hidden" name="mod" value="update">
        <div >{{.api.Name|html}}
         <button type="button" class="btn btn-link" data-toggle="modal" data-target="#modifyApiNameModal" data-whatever="{{.api.Name|html}}">修改</button>
        </div>
        {{else}}
        <input type="hidden" name="mod" value="new">
         <input class="form-control" type="text" required="required" pattern="[\w-]+" name="api_name" value="{{.api.Name|html}}" placeholder="需满足 [\w-]+"> 
        {{end}}
    </div>
</div>

<div class="form-group">
    <label class="col-sm-2 control-label">绑定路径:</label>
    <div class="col-sm-3">
     <input class="form-control" type="text" name="path" value="{{.api.Path}}" pattern="/([\w-]+/)*" placeholder="需满足/([\w-]+/)*">
    </div>
     {{if .api.Exists}}
    <div class="form-control-static"><a href="{{.api_url}}" target="_blank">{{.api_url}}</a></div>
    {{end}}
</div>
<div class="form-group">
    <label class="col-sm-2 control-label">描述:</label>
    <div class="col-sm-8">
     <input class="form-control" type="text" name="note" value="{{.api.Note|html}}">
    </div>
</div>

<div class="form-group">
    <label class="col-sm-2 control-label">超时:</label>
    <div class="col-sm-3">
	    <div class="input-group">
	        <input class="form-control text-right" type="text" name="timeout" value="{{.api.TimeoutMs}}">
	        <div class="input-group-addon">ms</div>
    </div>
    </div>
</div>

<div class="form-group">
    <label class="col-sm-2 control-label">状态:</label>
    <div class="col-sm-3 checkbox">
        <label>
        <input  type="checkbox" name="enable" value="1" {{if .api.Enable}}checked=checked{{end}}>
        启用
        </label>
    </div>
</div>

</fieldset>


<fieldset id="fieldset_hosts">
<legend>后端服务  <a onclick="proxy_api_host_add();return false;" href="#">+</a>
&nbsp;
<span class="legend_note">
 <label title="后端当作代理服务器，程序读到的HTTP_HOST将是{{.req_host}}">
        <input  type="checkbox" name="host_as_proxy" value="1" {{if .api.HostAsProxy}}checked=checked{{end}}>
        代理模式
 </label>
 &nbsp;
 </span>
</legend>
 <p class="text-muted">流量会复制到每个后端服务,然后随机选取其中一个Response返回。</p>
 <div id="div_hosts">
{{range $name,$host:=.api.Hosts}}
  <div>
    {{if in_array $name $.cookiePref}}
     <div class="bg-success my-panel" title="该后端已经设置为cookie的默认优先后端了，直接浏览器访问优先返回该主机结果">
    {{end}}
     {%my_include "api/form_base_host_row.html"%}
    {{if in_array $name $.cookiePref}}
    </div>
    {{end}}
  </div>
{{end}}
 </div>
</fieldset>
{{/*}}
<script>
$().ready(function(){
    $("#div_hosts").sortable({
    	update:function(e, ui){
            var index = $(ui.element).children().index(ui.item);
            $(ui.item).find("[name=sort_index]").val(index);
        }    	
    });
});
</script>
{{*/}}
<div class="t_c"><input type="submit" value="保 存" class="btn btn-default"></div>
</form>

<div class="hidden" id="api_host_tpl">
  {{range $name,$host:=.HostsTpl}}
    {%my_include "api/form_base_host_row.html"%}
  {{end}}
</div>


{{if .api.Exists}}
<div class="modal fade" id="modifyApiNameModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document" style="width:500px">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">修改模块名称</h4>
      </div>
      <form method="post" class="form-horizontal">
      <input  name="do" type="hidden" value="rename">
      <div class="modal-body">
          <div class="form-group">
            <label for="recipient-name" class="col-sm-3 control-label">模块名称：</label>
            <div class="col-sm-4">
	            <input name="orig_name" type="hidden" value="">
	            <input type="text" class="form-control" value="" name="new_name">
            </div>
               <span class="form-control-static emsg" id="mod_help" style='color:red;'></span>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
        </form>
    </div>
  </div>
</div>

<script>
$('#modifyApiNameModal').on('show.bs.modal', function (event) {
	  var button = $(event.relatedTarget)
	  var recipient = button.data('whatever')
	  var modal = $(this)
	  modal.find('.modal-body input').val(recipient)
	  modal.find(".emsg").html("")
	})
$("#modifyApiNameModal form").ajaxForm(function(data){
	if(data.code==0){
		location.href="/_api?name="+data.data
	}else{
		$("#mod_help").text(data.msg)
	}
});
</script>
{{end}}
